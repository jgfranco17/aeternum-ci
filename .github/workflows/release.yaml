name: Production Release

on:
  push:
    branches:
      - main

env:
  DOCKER_REGISTRY: ghcr.io/jgfranco17/aeternum-ci

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Golang
        uses: actions/setup-go@v5
        with:
          go-version: "1.21.4"

      - name: Install Just
        uses: extractions/setup-just@v2

      - name: Install Go modules
        run: |
          just tidy

      - name: Run tests
        run: |
          just test

  publish:
    runs-on: ubuntu-latest
    if: ${{ github.event.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
    needs: release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Golang
        uses: actions/setup-go@v5
        with:
          go-version: "1.21.4"

      - name: Install CI pre-requisites
        run: |
          sudo apt install jq
          sudo apt-get install gh

      - name: Get project version
        run: |
          VERSION=$(jq -r .version ./.github/specs.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Docker login
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.USER_GITHUB_NAME }}
          password: ${{ secrets.USER_GITHUB_TOKEN }}

      - name: Publish image
        env:
          GITHUB_TOKEN: ${{ secrets.USER_GITHUB_TOKEN }}
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/${{ secrets.USER_GITHUB_NAME }}/aeternum-ci:${{ env.VERSION }} -f ./docker/server.Dockerfile .
          docker push ${{ env.DOCKER_REGISTRY }}/${{ secrets.USER_GITHUB_NAME }}/aeternum-ci:${{ env.VERSION }}
